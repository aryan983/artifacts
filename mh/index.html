<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPU Cache Coherency ‚Äî Architecture Explorer</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;600;700;800&display=swap');
:root {
  --bg: #0a0b0f; --surface: #12141a; --surface2: #1a1d26;
  --border: #2a2d3a; --text: #e0e2ec; --dim: #6b7094;
  --l1: #ff6b6b; --l2: #ffa94d; --smem: #51cf66;
  --global: #339af0; --dram: #845ef7; --coherency: #f06595;
  --new-block: #22d3ee; --changed: #facc15;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--text); font-family:'Outfit',sans-serif; min-height:100vh; overflow-x:hidden; }
.grain { position:fixed; inset:0; pointer-events:none; z-index:999; opacity:.03;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }

header { text-align:center; padding:20px 16px 10px; }
header h1 { font-size:clamp(1.6rem,3.5vw,2.6rem); font-weight:800; letter-spacing:-1px;
background:linear-gradient(135deg,#ff6b6b,#ffa94d,#51cf66,#339af0,#845ef7);
-webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
header p { color:var(--dim); font-family:'JetBrains Mono',monospace; font-size:.75rem; margin-top:4px; letter-spacing:2px; text-transform:uppercase; }

.arch-tabs { display:flex; justify-content:center; gap:0; padding:10px 16px 6px; flex-wrap:wrap; }
.arch-tab {
background:var(--surface); border:1px solid var(--border); color:var(--dim);
font-family:'JetBrains Mono',monospace; font-size:.7rem; padding:8px 14px;
cursor:pointer; transition:all .2s; letter-spacing:.3px; position:relative;
border-right:none;
}
.arch-tab:first-child { border-radius:6px 0 0 6px; }
.arch-tab:last-child { border-radius:0 6px 6px 0; border-right:1px solid var(--border); }
.arch-tab:hover { color:var(--text); background:var(--surface2); }
.arch-tab.active { background:var(--surface2); color:#fff; border-color:var(--accent-color,var(--global)); }
.arch-tab.active::after { content:''; position:absolute; bottom:-1px; left:10%; right:10%; height:2px; background:var(--accent-color,var(--global)); border-radius:1px; }
.arch-tab .tab-gen { display:block; font-size:.55rem; color:var(--dim); margin-top:2px; font-weight:400; }
.arch-tab.active .tab-gen { color:var(--accent-color,var(--global)); }

.diff-banner {
max-width:1200px; margin:6px auto 0; padding:8px 14px;
background:var(--surface); border:1px solid var(--border); border-radius:8px;
font-size:.75rem; line-height:1.5; display:none; text-align:center;
}
.diff-banner.visible { display:block; }
.diff-banner .new-tag { color:var(--new-block); font-weight:600; }
.diff-banner .changed-tag { color:var(--changed); font-weight:600; }
.diff-banner .removed-tag { color:#ff6b6b; font-weight:600; text-decoration:line-through; }

.controls { display:flex; justify-content:center; gap:12px; padding:12px 20px; flex-wrap:wrap; }
.controls button {
background:var(--surface2); border:1px solid var(--border); color:var(--text);
font-family:'JetBrains Mono',monospace; font-size:.75rem; padding:8px 16px;
border-radius:6px; cursor:pointer; transition:all .2s; letter-spacing:.5px;
position:relative;
}
.controls button:hover { border-color:var(--coherency); color:#fff; }
.controls button.active { background:var(--coherency); border-color:var(--coherency); color:#fff; }
.controls button.reset-btn { background:transparent; border-color:#ff6b6b50; color:#ff6b6b; }
.controls button.reset-btn:hover { background:#ff6b6b20; border-color:#ff6b6b; }

/* ‚îÄ‚îÄ Pause button ‚îÄ‚îÄ */
.controls button.pause-btn {
  background:transparent; border-color:#845ef760; color:#845ef7;
}
.controls button.pause-btn:hover { background:#845ef720; border-color:#845ef7; color:#c0a8ff; }
.controls button.pause-btn.active { background:#845ef7; border-color:#845ef7; color:#fff; }

/* ‚îÄ‚îÄ Atomic button ‚îÄ‚îÄ */
.controls button.atomic-btn {
  background: transparent; border-color: #f59e0b60; color: #f59e0b;
}
.controls button.atomic-btn:hover { background:#f59e0b18; border-color:#f59e0b; color:#fbbf24; }
.controls button.atomic-btn.apex-only { display:none; }

/* ‚îÄ‚îÄ cp.async + TMA buttons ‚îÄ‚îÄ */
.controls button.cp-async-btn {
  background: transparent; border-color: #22d3ee50; color: #22d3ee;
}
.controls button.cp-async-btn:hover { background:#22d3ee15; border-color:#22d3ee; color:#67e8f9; }
.controls button.tma-btn {
  background: transparent; border-color: #22d3ee50; color: #22d3ee;
}
.controls button.tma-btn:hover { background:#22d3ee15; border-color:#22d3ee; color:#67e8f9; }

/* ‚îÄ‚îÄ Rich block info panel (arbiter etc.) ‚îÄ‚îÄ */
.arb-section { margin-bottom: 10px; }
.arb-section-title {
  font-family: 'JetBrains Mono', monospace; font-size: .6rem;
  text-transform: uppercase; letter-spacing: 1.5px;
  color: #f59e0b; margin-bottom: 5px; padding-bottom: 3px;
  border-bottom: 1px solid #f59e0b22;
}
.arb-section-title.green { color: #51cf66; border-bottom-color: #51cf6622; }
.arb-section-title.blue  { color: #339af0; border-bottom-color: #339af022; }
.arb-section-title.purple{ color: #a78bfa; border-bottom-color: #a78bfa22; }
.arb-section-title.pink  { color: #ffa94d; border-bottom-color: #ffa94d22; }
.arb-pipeline {
  display: flex; align-items: center; gap: 0; margin: 6px 0 8px;
  font-family: 'JetBrains Mono', monospace; font-size: .58rem;
}
.arb-step {
  background: #1a1d26; border: 1px solid #2a2d3a; border-radius: 4px;
  padding: 3px 6px; color: #aaa; white-space: nowrap; position: relative;
}
.arb-step.amber { border-color: #f59e0b50; color: #f59e0b; background: #f59e0b0a; }
.arb-step.green { border-color: #51cf6650; color: #51cf66; background: #51cf660a; }
.arb-step.blue  { border-color: #339af050; color: #339af0; background: #339af00a; }
.arb-step.orange{ border-color: #ffa94d50; color: #ffa94d; background: #ffa94d0a; }
.arb-step.purple{ border-color: #a78bfa50; color: #a78bfa; background: #a78bfa0a; }
.arb-arrow { color: #3a3d55; font-size: .65rem; padding: 0 2px; }
.arb-row { display: flex; gap: 6px; margin-bottom: 4px; font-size: .73rem; line-height: 1.5; }
.arb-row-label {
  font-family: 'JetBrains Mono', monospace; font-size: .6rem;
  color: #f59e0b; min-width: 60px; flex-shrink: 0; padding-top: 1px;
}
.arb-row-val { color: #c0c4d8; flex: 1; }
.arb-note { font-size: .7rem; color: #6b7094; line-height: 1.55; margin-bottom: 6px; font-style: italic; }
.arb-tag {
  display: inline-block; font-family: 'JetBrains Mono', monospace;
  font-size: .55rem; padding: 1px 5px; border-radius: 3px; margin: 1px 2px;
  border: 1px solid; vertical-align: middle;
}
.arb-tag.amber { color: #f59e0b; border-color: #f59e0b50; background: #f59e0b10; }
.arb-tag.green { color: #51cf66; border-color: #51cf6650; background: #51cf6610; }
.arb-tag.blue  { color: #339af0; border-color: #339af050; background: #339af010; }
.arb-tag.purple{ color: #a78bfa; border-color: #a78bfa50; background: #a78bfa10; }
.arb-tag.orange{ color: #ffa94d; border-color: #ffa94d50; background: #ffa94d10; }
.arb-divider { border: none; border-top: 1px solid #1e2030; margin: 8px 0; }
.tt-wide {
  max-width: 380px !important;
  min-width: 340px !important;
}
.tt-arb-section {
  margin-top: 8px;
  padding-top: 7px;
  border-top: 1px solid var(--border);
}
.tt-arb-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: .56rem;
  color: #6b7090;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 4px;
}
.tt-arb-queue {
  display: flex;
  gap: 3px;
  flex-wrap: wrap;
  margin-bottom: 3px;
}
.tt-arb-slot {
  width: 26px; height: 18px;
  border-radius: 3px;
  background: #1e2030;
  border: 1px solid #2a2d3a;
  font-family: 'JetBrains Mono', monospace;
  font-size: .56rem;
  display: flex; align-items: center; justify-content: center;
  color: #6b7090;
  transition: all .2s;
}
.tt-arb-slot.occ { background:#f59e0b22; border-color:#f59e0b80; color:#fbbf24; }
.tt-arb-slot.ret { background:#339af022; border-color:#339af080; color:#339af0; }
.tt-arb-slot.don { background:#51cf6622; border-color:#51cf6680; color:#51cf66; }
.tt-arb-rob {
  display: flex;
  gap: 3px;
  margin-bottom: 3px;
}
.tt-arb-rob-slot {
  flex: 1;
  height: 16px;
  border-radius: 3px;
  background: #1e2030;
  border: 1px solid #2a2d3a;
  font-family: 'JetBrains Mono', monospace;
  font-size: .5rem;
  display: flex; align-items: center; justify-content: center;
  color: #6b7090;
}
.tt-arb-rob-slot.pend { background:#f59e0b18; border-color:#f59e0b50; color:#f59e0b; }
.tt-arb-rob-slot.comp { background:#339af018; border-color:#339af050; color:#339af0; }
.tt-arb-rob-slot.retr { background:#a78bfa18; border-color:#a78bfa50; color:#a78bfa; }
.tt-arb-rob-slot.done { background:#51cf6618; border-color:#51cf6650; color:#51cf66; }
.tt-arb-bar-bg {
  height: 5px; border-radius: 3px; background: #1e2030;
  overflow: hidden; margin: 3px 0;
}
.tt-arb-bar-fill {
  height: 100%; border-radius: 3px;
  background: linear-gradient(90deg, #51cf66, #f59e0b, #ff6b6b);
  transition: width .3s;
}
.tt-arb-grant-log {
  font-family: 'JetBrains Mono', monospace;
  font-size: .58rem;
  color: #6b7090;
  line-height: 1.7;
}
.tt-arb-grant-log .gs { color: #f59e0b; }
.tt-arb-grant-log .gc { color: #e0e2ec; }

/* ‚îÄ‚îÄ Latency badge on blocks ‚îÄ‚îÄ */
.lat-badge {
  position: absolute;
  pointer-events: none;
  z-index: 25;
  font-family: 'JetBrains Mono', monospace;
  font-size: .58rem;
  font-weight: 700;
  padding: 2px 7px;
  border-radius: 4px;
  border: 1px solid currentColor;
  opacity: 0;
  transition: opacity .2s;
  white-space: nowrap;
}
.lat-badge.visible { opacity: 1; }
.paused-badge.visible { display:block; }

/* ‚îÄ‚îÄ Scenario tooltip ‚îÄ‚îÄ */
#scenario-tooltip {
  position:fixed; pointer-events:none; z-index:300;
  background:#090b12; border:1px solid var(--border);
  border-radius:12px; padding:14px 16px; max-width:290px; min-width:220px;
  box-shadow:0 14px 44px rgba(0,0,0,.9);
  opacity:0; transition:opacity .15s, transform .15s;
  transform:translateY(6px);
  font-size:.75rem; line-height:1.6;
}
#scenario-tooltip.visible { opacity:1; transform:translateY(0); }
#scenario-tooltip .st-title {
  font-family:'JetBrains Mono',monospace; font-weight:700; font-size:.82rem;
  margin-bottom:8px; display:flex; align-items:center; gap:8px;
}
#scenario-tooltip .st-dot { width:8px; height:8px; border-radius:2px; flex-shrink:0; }
#scenario-tooltip .st-desc { color:#c8cce0; font-size:.75rem; line-height:1.55; margin-bottom:8px; }
#scenario-tooltip .st-detail {
  background:#0f1520; border:1px solid #339af020; border-radius:7px;
  padding:8px 10px;
}
#scenario-tooltip .st-detail-label {
  font-family:'JetBrains Mono',monospace; font-size:.55rem; font-weight:700;
  text-transform:uppercase; letter-spacing:1.5px; color:#339af099; margin-bottom:3px;
}
#scenario-tooltip .st-detail-text { color:#90c8f0; font-size:.72rem; line-height:1.5; }

.main-container { display:flex; gap:24px; padding:12px 20px; max-width:1400px; margin:0 auto; align-items:flex-start; }
.viz-area { flex:1; min-width:0; position:relative; }
canvas { width:100%; height:720px; background:var(--surface); border-radius:12px; border:1px solid var(--border); display:block; cursor:default; }
@media(max-width:500px){ canvas { height:640px; } .viz-area { max-width:none; } }

/* ‚îÄ‚îÄ Tooltip ‚îÄ‚îÄ */
#block-tooltip {
  position:absolute; pointer-events:none; z-index:100;
  background:#0d0f16; border:1px solid var(--border);
  border-radius:10px; padding:11px 14px; max-width:240px;
  box-shadow: 0 8px 32px rgba(0,0,0,.7);
  opacity:0; transition:opacity .15s;
  font-size:.75rem; line-height:1.55;
}
#block-tooltip.visible { opacity:1; }
#block-tooltip .tt-title { font-weight:700; font-size:.85rem; margin-bottom:6px; display:flex; align-items:center; gap:7px; }
#block-tooltip .tt-dot { width:9px; height:9px; border-radius:3px; flex-shrink:0; }
#block-tooltip .tt-desc { color:var(--dim); margin-bottom:7px; }
#block-tooltip .tt-meta { display:flex; flex-wrap:wrap; gap:5px; }
#block-tooltip .tt-chip {
  font-family:'JetBrains Mono',monospace; font-size:.6rem; font-weight:600;
  padding:2px 7px; border-radius:4px;
}
#block-tooltip .tt-hint {
  margin-top:8px; padding-top:6px; border-top:1px solid var(--border);
  font-size:.65rem; color:#6b7094; font-family:'JetBrains Mono',monospace;
  display:flex; align-items:center; gap:5px;
}
#block-tooltip .tt-hint::before { content:'‚óâ'; font-size:.7rem; }

/* ‚îÄ‚îÄ Instruction tooltip ‚îÄ‚îÄ */
#instr-tooltip {
  position:fixed; pointer-events:none; z-index:200;
  background:#080a10; border:1px solid var(--border);
  border-radius:12px; padding:14px 16px; max-width:310px; min-width:240px;
  box-shadow: 0 12px 40px rgba(0,0,0,.85);
  opacity:0; transition:opacity .15s, transform .15s;
  transform:translateY(4px);
  font-size:.75rem; line-height:1.6;
}
#instr-tooltip.visible { opacity:1; transform:translateY(0); }
#instr-tooltip .it-name {
  font-family:'JetBrains Mono',monospace; font-weight:700; font-size:.82rem;
  margin-bottom:8px; display:flex; align-items:center; gap:8px;
}
#instr-tooltip .it-dot { width:8px; height:8px; border-radius:2px; flex-shrink:0; }
#instr-tooltip .it-section { margin-bottom:8px; }
#instr-tooltip .it-label {
  font-family:'JetBrains Mono',monospace; font-size:.55rem; font-weight:700;
  text-transform:uppercase; letter-spacing:1.5px; color:#6b7094; margin-bottom:3px;
}
#instr-tooltip .it-text { color:#c8cce0; font-size:.74rem; line-height:1.55; }
#instr-tooltip .it-why-box {
  background:#0f1a12; border:1px solid #51cf6625; border-radius:7px;
  padding:8px 10px; margin-top:6px;
}
#instr-tooltip .it-why-box .it-label { color:#51cf6699; }
#instr-tooltip .it-why-box .it-text { color:#a0dbb0; }

/* ‚îÄ‚îÄ Selection panel ‚îÄ‚îÄ */
#sel-panel {
  background:var(--surface); border:1px solid var(--border); border-radius:10px;
  padding:14px; display:none; margin-top:12px;
}
#sel-panel { max-height: 70vh; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #2a2d3a transparent; }
#sel-panel.visible { display:block; }
#sel-panel h4 { font-size:.65rem; font-family:'JetBrains Mono',monospace; text-transform:uppercase; letter-spacing:2px; color:var(--dim); margin-bottom:10px; }
#sel-panel .sel-name { font-weight:700; font-size:.95rem; margin-bottom:6px; }
#sel-panel .sel-desc { font-size:.78rem; color:var(--dim); line-height:1.55; margin-bottom:10px; }
#sel-panel .sel-connections { }
#sel-panel .sel-connections h5 { font-size:.6rem; font-family:'JetBrains Mono',monospace; text-transform:uppercase; letter-spacing:1.5px; color:var(--dim); margin-bottom:7px; }
#sel-panel .conn-list { display:flex; flex-direction:column; gap:5px; }
#sel-panel .conn-item {
  display:flex; align-items:flex-start; gap:8px; padding:7px 10px;
  background:var(--bg); border-radius:6px; border:1px solid var(--border);
  font-size:.75rem; line-height:1.45; cursor:pointer; transition:border-color .15s;
}
#sel-panel .conn-item:hover { border-color: #4a4d5a; }
#sel-panel .conn-item .ci-arrow { font-family:'JetBrains Mono',monospace; font-size:.7rem; flex-shrink:0; margin-top:1px; }
#sel-panel .conn-item .ci-body { flex:1; }
#sel-panel .conn-item .ci-target { font-weight:600; }
#sel-panel .conn-item .ci-why { color:var(--dim); font-size:.7rem; display:block; }
#sel-panel .close-btn { float:right; font-size:.7rem; color:var(--dim); cursor:pointer; font-family:'JetBrains Mono',monospace; padding:2px 6px; border:1px solid var(--border); border-radius:4px; }
#sel-panel .close-btn:hover { color:var(--text); }

.info-panel { width:360px; flex-shrink:0; display:flex; flex-direction:column; gap:12px; }
.info-card { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:14px; }
.info-card h3 { font-size:.65rem; font-family:'JetBrains Mono',monospace; text-transform:uppercase; letter-spacing:2px; color:var(--dim); margin-bottom:10px; }

/* Instruction reference chips */
.instr-section { margin-top:0; }
.instr-chips { display:flex; flex-wrap:wrap; gap:8px; }
.instr-chip {
  font-family:'JetBrains Mono',monospace; font-size:.72rem; font-weight:700;
  padding:5px 11px; border-radius:6px; cursor:pointer;
  border:1px solid transparent; transition:all .15s;
  user-select:none;
}
.instr-chip:hover { transform:translateY(-1px); box-shadow:0 4px 14px rgba(0,0,0,.4); }

.bottom-section { max-width:1200px; margin:0 auto; padding:0 20px 30px; }
.bottom-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }

@media(min-width:1101px) {
.perf-bars { height:32px; }
.perf-bar-val { font-size:.58rem; }
.perf-label { min-width:70px; font-size:.75rem; }
}

.acc-item { border-bottom:1px solid var(--border); }
.acc-item:last-child { border-bottom:none; }
.acc-head { display:flex; align-items:center; gap:8px; padding:8px 0; cursor:pointer; user-select:none; -webkit-user-select:none; }
.acc-head:active { opacity:.7; }
.acc-dot { width:8px; height:8px; border-radius:3px; flex-shrink:0; }
.acc-title { flex:1; font-weight:600; font-size:.8rem; }
.acc-meta { font-family:'JetBrains Mono',monospace; font-size:.6rem; color:var(--dim); }
.acc-chev { font-size:.65rem; color:var(--dim); transition:transform .25s; }
.acc-item.open .acc-chev { transform:rotate(90deg); }
.acc-body { max-height:0; overflow:hidden; transition:max-height .3s,padding .3s; padding:0 0 0 16px; }
.acc-item.open .acc-body { max-height:350px; padding:0 0 8px 16px; }
.acc-body p { font-size:.75rem; line-height:1.5; color:var(--dim); margin:0; }
.acc-body p strong { color:var(--text); }
.acc-badge-new { font-size:.55rem; background:var(--new-block); color:#000; padding:1px 5px; border-radius:3px; font-weight:700; margin-left:4px; }
.acc-badge-changed { font-size:.55rem; background:var(--changed); color:#000; padding:1px 5px; border-radius:3px; font-weight:700; margin-left:4px; }

.stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
.stat-item { background:var(--bg); border-radius:6px; padding:8px; text-align:center; }
.stat-value { font-size:1.3rem; font-weight:700; font-family:'JetBrains Mono',monospace; }
.stat-label { font-size:.6rem; color:var(--dim); text-transform:uppercase; letter-spacing:1px; margin-top:1px; }

.state-row { display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:.8rem; }
.state-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.state-label { font-weight:600; min-width:70px; }
.state-desc { color:var(--dim); font-size:.73rem; }

.explainer { position:relative; overflow:hidden; min-height:100px; max-height:400px; }
.explainer::before { content:''; position:absolute; top:0; left:0; right:0; height:3px;
background:linear-gradient(90deg,var(--l1),var(--l2),var(--smem),var(--global),var(--dram)); border-radius:10px 10px 0 0; opacity:.6; }
.explainer-title { font-weight:700; font-size:.95rem; margin-bottom:8px; display:flex; align-items:center; gap:8px; }
.explainer-title .dot { width:8px; height:8px; border-radius:50%; animation:pulse-dot 1.5s ease-in-out infinite; }
@keyframes pulse-dot { 0%,100%{opacity:.5;transform:scale(1)} 50%{opacity:1;transform:scale(1.3)} }
.step-list { list-style:none; max-height:220px; overflow-y:auto; overscroll-behavior:contain; scrollbar-width:thin; scrollbar-color:var(--border) transparent; }
.step-list::-webkit-scrollbar{width:4px} .step-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.step-list li { display:flex; align-items:flex-start; gap:8px; padding:5px 0; font-size:.78rem; line-height:1.4; opacity:0; transform:translateX(-6px); transition:opacity .4s,transform .4s; }
.step-list li.visible { opacity:1; transform:translateX(0); }
.step-list li.active { opacity:1; transform:translateX(0); }
.step-list li.past { opacity:.4; }
.step-num { font-family:'JetBrains Mono',monospace; font-size:.65rem; font-weight:600; min-width:18px; height:18px; display:flex; align-items:center; justify-content:center; border-radius:4px; flex-shrink:0; }
.step-text { flex:1; }
.step-text .micro { display:block; font-size:.68rem; color:var(--dim); font-family:'JetBrains Mono',monospace; margin-top:1px; }
.explainer-summary { margin-top:8px; padding-top:8px; border-top:1px solid var(--border); font-size:.73rem; color:var(--dim); font-style:italic; opacity:0; transition:opacity .5s; }
.explainer-summary.visible { opacity:1; }

.event-log { max-height:160px; overflow-y:auto; overscroll-behavior:contain; scrollbar-width:thin; scrollbar-color:var(--border) transparent; }
.event-log::-webkit-scrollbar{width:4px} .event-log::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.log-entry { font-family:'JetBrains Mono',monospace; font-size:.65rem; padding:3px 0; border-bottom:1px solid rgba(42,45,58,.5); color:var(--dim); animation:fadeIn .3s; }
.log-entry .tag { display:inline-block; padding:1px 5px; border-radius:3px; font-size:.6rem; margin-right:3px; }
@keyframes fadeIn { from{opacity:0;transform:translateY(-4px)} to{opacity:1;transform:translateY(0)} }

.arch-intro { max-width:1200px; margin:6px auto 0; padding:0 20px; }
.arch-intro-inner {
background:var(--surface); border:1px solid var(--border); border-radius:10px;
padding:14px 16px; display:flex; gap:14px; align-items:flex-start;
}
.arch-intro-badge {
font-family:'JetBrains Mono',monospace; font-size:.6rem; font-weight:700;
padding:4px 10px; border-radius:5px; white-space:nowrap; flex-shrink:0; margin-top:2px;
}
.arch-intro-text { font-size:.8rem; line-height:1.55; color:var(--dim); }
.arch-intro-text strong { color:var(--text); }
.arch-intro-delta { font-size:.78rem; line-height:1.5; color:var(--dim); margin-top:5px; padding:5px 10px; border-left:2px solid #f59e0b40; background:#f59e0b08; border-radius:0 4px 4px 0; }
.arch-intro-delta strong { color:var(--text); }

.easy-card { border-left:3px solid var(--smem); }
.easy-card h3 span { color:var(--smem); font-size:.6rem; margin-left:6px; font-weight:400; }
.easy-q { padding:8px 0; border-bottom:1px solid var(--border); cursor:pointer; user-select:none; -webkit-user-select:none; }
.easy-q:last-child { border-bottom:none; }
.easy-q:active { opacity:.7; }
.easy-head { display:flex; align-items:center; gap:8px; }
.easy-emoji { font-size:1rem; flex-shrink:0; width:22px; text-align:center; }
.easy-title { flex:1; font-weight:600; font-size:.82rem; }
.easy-chev { font-size:.65rem; color:var(--dim); transition:transform .25s; }
.easy-q.open .easy-chev { transform:rotate(90deg); }
.easy-body { max-height:0; overflow:hidden; transition:max-height .3s,padding .3s; padding:0 0 0 30px; }
.easy-q.open .easy-body { max-height:500px; padding:4px 0 6px 30px; }
.easy-body p { font-size:.78rem; line-height:1.6; color:var(--dim); margin:0 0 6px; }
.easy-body p strong { color:var(--text); }
.easy-body .analogy { font-style:italic; color:var(--smem); font-size:.73rem; }

.perf-card h3 { margin-bottom:12px; }
.perf-row { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
.perf-label { font-size:.7rem; font-family:'JetBrains Mono',monospace; color:var(--dim); min-width:65px; flex-shrink:0; }
.perf-bars { flex:1; display:flex; gap:2px; height:28px; align-items:flex-end; }
.perf-bar {
flex:1; border-radius:2px 2px 0 0; position:relative; min-height:2px;
transition:height .4s ease; display:flex; align-items:flex-end; justify-content:center;
}
.perf-bar-val {
font-family:'JetBrains Mono',monospace; font-size:.5rem; font-weight:600;
position:absolute; top:-12px; width:100%; text-align:center; white-space:nowrap;
}
.perf-bar.active { outline:1px solid #fff3; outline-offset:1px; }
.perf-legend { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; justify-content:center; }
.perf-legend-item { display:flex; align-items:center; gap:4px; font-size:.6rem; font-family:'JetBrains Mono',monospace; color:var(--dim); }
.perf-legend-dot { width:8px; height:8px; border-radius:2px; }

@media(max-width:1100px) {
.main-container { flex-direction:column; }
.info-panel { width:100%; flex-direction:row; flex-wrap:wrap; }
.info-card { flex:1; min-width:260px; }
.bottom-grid { grid-template-columns:1fr; }
}
</style>
</head>
<body>
<div class="grain"></div>

<header>
  <h1>GPU Cache Coherency</h1>
  <p>Architecture Explorer ¬∑ Memory Hierarchy ¬∑ Data Flow</p>
</header>

<div class="arch-tabs" id="arch-tabs">
  <div class="arch-tab active" data-arch="pascal" style="--accent-color:#51cf66" onclick="switchArch('pascal')">Pascal<span class="tab-gen">SM 6.1 ¬∑ 2016</span></div>
  <div class="arch-tab" data-arch="volta" style="--accent-color:#339af0" onclick="switchArch('volta')">Volta<span class="tab-gen">SM 7.0 ¬∑ 2017</span></div>
  <div class="arch-tab" data-arch="ampere" style="--accent-color:#ffa94d" onclick="switchArch('ampere')">Ampere<span class="tab-gen">SM 8.0 ¬∑ 2020</span></div>
  <div class="arch-tab" data-arch="hopper" style="--accent-color:#845ef7" onclick="switchArch('hopper')">Hopper<span class="tab-gen">SM 9.0 ¬∑ 2022</span></div>
  <div class="arch-tab" data-arch="apex" style="--accent-color:#f59e0b" onclick="switchArch('apex')">Apex ‚ú¶<span class="tab-gen">SM 10.0 ¬∑ Concept</span></div>
</div>

<div class="diff-banner" id="diff-banner"></div>
<div class="arch-intro"><div class="arch-intro-inner" id="arch-intro"></div></div>

<div class="controls">
  <button class="scenario-btn" data-scenario="read"   onclick="triggerScenario('read')">SM Read</button>
  <button class="scenario-btn" data-scenario="write"  onclick="triggerScenario('write')">SM Write</button>
  <button class="scenario-btn" data-scenario="invalidate" onclick="triggerScenario('invalidate')">Invalidate</button>
  <button class="scenario-btn" data-scenario="writeback"  onclick="triggerScenario('writeback')">Write-Back</button>
  <button class="scenario-btn" data-scenario="shared"     onclick="triggerScenario('shared')">Shared Mem</button>
  <button class="scenario-btn" data-scenario="reg_spill"  onclick="triggerScenario('reg_spill')" id="btn-reg-spill">Reg Spill</button>
  <button class="scenario-btn atomic-btn" data-scenario="atomic" onclick="triggerScenario('atomic')" id="btn-atomic">‚öõ atomicAdd</button>
  <button class="scenario-btn cp-async-btn" data-scenario="cp_async" onclick="triggerScenario('cp_async')" id="btn-cp-async" style="display:none">cp.async</button>
  <button class="scenario-btn tma-btn" data-scenario="tma_load" onclick="triggerScenario('tma_load')" id="btn-tma-load" style="display:none">TMA Load</button>
  <button id="btn-pause" class="pause-btn" onclick="togglePause()">‚è∏ Pause</button>
  <button id="btn-auto" class="active" onclick="toggleAuto()">Auto</button>
  <button class="reset-btn" onclick="resetAll()">Reset</button>
</div>

<div class="main-container">
  <div class="viz-area">
    <canvas id="canvas"></canvas>
    <!-- paused badge removed -->
    <!-- Block tooltip -->
    <div id="block-tooltip">
      <div class="tt-title"><div class="tt-dot" id="tt-dot"></div><span id="tt-name"></span></div>
      <div class="tt-desc" id="tt-desc"></div>
      <div class="tt-meta" id="tt-meta"></div>
      <div class="tt-hint" id="tt-hint">Click to explore connections</div>
    </div>
    <!-- Selection panel -->
    <div id="sel-panel">
      <span class="close-btn" onclick="clearSelection()">‚úï close</span>
      <h4>Block Selected</h4>
      <div class="sel-name" id="sel-name"></div>
      <div class="sel-desc" id="sel-desc"></div>
      <div class="sel-connections">
        <h5>Connects To</h5>
        <div class="conn-list" id="conn-list"></div>
      </div>
    </div>
  </div>
  <div class="info-panel">
    <div class="info-card" id="key-card"></div>
    <div class="info-card">
      <h3>Cache States (MSI)</h3>
      <div class="state-row"><div class="state-dot" style="background:#51cf66"></div><span class="state-label">Modified</span><span class="state-desc">Dirty, exclusive</span></div>
      <div class="state-row"><div class="state-dot" style="background:#339af0"></div><span class="state-label">Shared</span><span class="state-desc">Clean, multi-reader</span></div>
      <div class="state-row"><div class="state-dot" style="background:#555"></div><span class="state-label">Invalid</span><span class="state-desc">Stale / absent</span></div>
    </div>
    <div class="info-card">
      <h3>Live Stats</h3>
      <div class="stats-grid">
        <div class="stat-item"><div class="stat-value" id="stat-hits" style="color:var(--smem)">0</div><div class="stat-label">Hits</div></div>
        <div class="stat-item"><div class="stat-value" id="stat-misses" style="color:var(--l1)">0</div><div class="stat-label">Misses</div></div>
        <div class="stat-item"><div class="stat-value" id="stat-inv" style="color:var(--coherency)">0</div><div class="stat-label">Invalidations</div></div>
        <div class="stat-item"><div class="stat-value" id="stat-wb" style="color:var(--l2)">0</div><div class="stat-label">Write-Backs</div></div>
      </div>
    </div>
    <div class="info-card explainer" id="explainer-card">
      <h3>What's Happening</h3>
      <div id="explainer-title" class="explainer-title" style="color:var(--dim)"><span class="dot" style="background:var(--dim)"></span>Click a scenario or wait for auto...</div>
      <ol class="step-list" id="step-list"></ol>
      <div class="explainer-summary" id="explainer-summary"></div>
    </div>
    <div class="info-card">
      <h3>Event Log</h3>
      <div class="event-log" id="event-log"></div>
    </div>
  </div>
</div>

<div class="bottom-section">
  <div class="bottom-grid">
    <div class="info-card easy-card">
      <h3>Easy Explain <span>for beginners</span></h3>
      <div class="easy-q" onclick="this.classList.toggle('open')">
        <div class="easy-head"><span class="easy-emoji">üè†</span><span class="easy-title">What is a cache?</span><span class="easy-chev">‚ñ∏</span></div>
        <div class="easy-body"><p>A cache is a <strong>small, fast storage</strong> that keeps copies of frequently used data close to where it's needed.</p><p class="analogy">Analogy: Your desk (cache) vs the library (main memory). You keep the books you're reading on your desk so you don't have to walk to the library every time.</p></div>
      </div>
      <div class="easy-q" onclick="this.classList.toggle('open')">
        <div class="easy-head"><span class="easy-emoji">ü§ù</span><span class="easy-title">What is cache coherency?</span><span class="easy-chev">‚ñ∏</span></div>
        <div class="easy-body"><p>When <strong>multiple processors</strong> (SMs) each have their own cache, they might hold different copies of the same data. Cache coherency keeps everyone's copies consistent.</p></div>
      </div>
      <div class="easy-q" onclick="this.classList.toggle('open')">
        <div class="easy-head"><span class="easy-emoji">üì¶</span><span class="easy-title">What is an SM?</span><span class="easy-chev">‚ñ∏</span></div>
        <div class="easy-body"><p>A <strong>Streaming Multiprocessor</strong> is the GPU's core compute unit. Each SM runs thousands of threads in parallel using "warps" (groups of 32 threads).</p></div>
      </div>
      <div class="easy-q" onclick="this.classList.toggle('open')">
        <div class="easy-head"><span class="easy-emoji">‚ö°</span><span class="easy-title">Shared memory vs L1?</span><span class="easy-chev">‚ñ∏</span></div>
        <div class="easy-body"><p><strong>L1</strong> is automatic ‚Äî hardware decides what to cache. <strong>Shared memory</strong> is manual ‚Äî programmer explicitly loads data. Faster and predictable, but more work.</p></div>
      </div>
      <div class="easy-q" onclick="this.classList.toggle('open')">
        <div class="easy-head"><span class="easy-emoji">üö´</span><span class="easy-title">What does "invalidate" mean?</span><span class="easy-chev">‚ñ∏</span></div>
        <div class="easy-body"><p>When one SM writes, others' cached copies become <strong>outdated</strong>. Invalidation says "throw away your copy." Next access fetches fresh from L2.</p></div>
      </div>
      <div class="easy-q" onclick="this.classList.toggle('open')">
        <div class="easy-head"><span class="easy-emoji">üîÑ</span><span class="easy-title">What does "write-evict" mean?</span><span class="easy-chev">‚ñ∏</span></div>
        <div class="easy-body"><p>Instead of keeping a dirty copy in L1, the SM <strong>drops the L1 copy entirely</strong> and writes straight to L2. Simpler than CPU write-back but more L2 traffic.</p></div>
      </div>
    </div>
  </div>
</div>

<div class="bottom-section instr-section">
  <div class="bottom-grid">
    <div class="info-card" id="instr-ref-card">
      <h3>Instruction Reference <span style="font-size:.6rem;color:var(--dim);font-weight:400;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:1px">‚Äî hover any chip</span></h3>
      <div class="instr-chips" id="instr-chips"></div>
    </div>
  </div>
</div>

<!-- Scenario tooltip at body level -->
<div id="scenario-tooltip">
  <div class="st-title"><div class="st-dot" id="st-dot"></div><span id="st-title-text"></span></div>
  <div class="st-desc" id="st-desc-text"></div>
  <div class="st-detail">
    <div class="st-detail-label">What to watch for</div>
    <div class="st-detail-text" id="st-watch-text"></div>
  </div>
</div>

<!-- Instruction tooltip at body level so fixed positioning works correctly -->
<div id="instr-tooltip">
  <div class="it-name"><div class="it-dot" id="it-dot"></div><span id="it-name"></span></div>
  <div class="it-section">
    <div class="it-label">What it does</div>
    <div class="it-text" id="it-what"></div>
  </div>
  <div class="it-why-box">
    <div class="it-label">Why you need this op</div>
    <div class="it-text" id="it-why"></div>
  </div>
</div>
  <script src="src/globals.js"></script>
  <script src="src/data.js"></script>
  <script src="src/cache.js"></script>
  <script src="src/tooltip.js"></script>
  <script src="src/draw.js"></script>
  <script src="src/particles.js"></script>
  <script src="src/scenarios.js"></script>
  <script src="src/arbiter.js"></script>
  <script src="src/atomic.js"></script>
</body>
</html>
